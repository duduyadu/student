<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¶„ì„ ëŒ€ì‹œë³´ë“œ - AJU E&J</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    header p {
      font-size: 14px;
      opacity: 0.9;
    }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 24px;
      border: none;
      background: #f0f0f0;
      color: #333;
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .tab-btn:hover {
      background: #e0e0e0;
    }

    .tab-btn.active {
      background: #4285F4;
      color: white;
    }

    /* í•„í„° íŒ¨ë„ */
    .filters {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
    }

    .filter-group input,
    .filter-group select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #4285F4;
    }

    .filter-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 15px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #4285F4;
      color: white;
    }

    .btn-primary:hover {
      background: #3367D6;
    }

    .btn-secondary {
      background: #34A853;
      color: white;
    }

    .btn-secondary:hover {
      background: #2D8E47;
    }

    .btn-danger {
      background: #EA4335;
      color: white;
    }

    .btn-danger:hover {
      background: #D33B2C;
    }

    /* ì½˜í…ì¸  ì˜ì—­ */
    .content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
    .chart-container {
      position: relative;
      height: 400px;
      margin-bottom: 30px;
    }

    /* ë°ì´í„° í…Œì´ë¸” */
    .data-table-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    table th {
      background: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid #ddd;
    }

    table td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
    }

    table tr:hover {
      background: #f9f9f9;
    }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4285F4;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ì—ëŸ¬ ë©”ì‹œì§€ */
    .error {
      display: none;
      background: #FFEBEE;
      color: #C62828;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #C62828;
    }

    .error.active {
      display: block;
    }

    /* ì„±ê³µ ë©”ì‹œì§€ */
    .success {
      display: none;
      background: #E8F5E9;
      color: #2E7D32;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #2E7D32;
    }

    .success.active {
      display: block;
    }

    /* Summary ì¹´ë“œ */
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .summary-card h3 {
      font-size: 14px;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .summary-card p {
      font-size: 28px;
      font-weight: 700;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      header h1 {
        font-size: 20px;
      }

      .tabs {
        padding: 10px;
      }

      .tab-btn {
        padding: 10px 16px;
        font-size: 13px;
      }

      .filter-row {
        grid-template-columns: 1fr;
      }

      .chart-container {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- í—¤ë” -->
    <header>
      <h1>ğŸ“Š ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
      <p>í•™ìƒ ë°ì´í„° ë¶„ì„ ë° ë¦¬í¬íŒ… ì‹œìŠ¤í…œ</p>
    </header>

    <!-- ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ -->
    <div class="error" id="errorMessage"></div>
    <div class="success" id="successMessage"></div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('cohort')">ì½”í˜¸íŠ¸ ë¶„ì„</button>
      <button class="tab-btn" onclick="switchTab('trend')">íŠ¸ë Œë“œ ë¶„ì„</button>
      <button class="tab-btn" onclick="switchTab('funnel')">ê¹”ë•Œê¸° ë¶„ì„</button>
      <button class="tab-btn" onclick="switchTab('report')">ì‚¬ìš©ì ì •ì˜ ë¦¬í¬íŠ¸</button>
    </div>

    <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- ì½˜í…ì¸  ì˜ì—­ -->
    <div class="content">
      <!-- ì½”í˜¸íŠ¸ ë¶„ì„ íƒ­ -->
      <div id="cohort-tab" class="tab-content active">
        <h2>ì½”í˜¸íŠ¸ ë¶„ì„</h2>
        <p style="margin-bottom: 20px; color: #666;">ì…í•™ ì—°ë„ë³„ ë˜ëŠ” ìœ í•™ì›ë³„ í•™ìƒ ê·¸ë£¹ì„ ë¹„êµí•©ë‹ˆë‹¤.</p>

        <!-- í•„í„° -->
        <div class="filters">
          <div class="filter-row">
            <div class="filter-group">
              <label>ì½”í˜¸íŠ¸ ìœ í˜•</label>
              <select id="cohort-type">
                <option value="year">ì…í•™ ì—°ë„ë³„</option>
                <option value="agency">ìœ í•™ì›ë³„</option>
              </select>
            </div>
            <div class="filter-group">
              <label>ë¶„ì„ ì§€í‘œ</label>
              <select id="cohort-metric">
                <option value="topik_improvement">TOPIK í‰ê·  í–¥ìƒë„</option>
                <option value="target_change">ëª©í‘œ ëŒ€í•™ ë³€ê²½ íšŸìˆ˜</option>
                <option value="consult_count">ìƒë‹´ íšŸìˆ˜</option>
              </select>
            </div>
            <div class="filter-group">
              <label>ì‹œì‘ ì—°ë„</label>
              <input type="number" id="cohort-start-year" value="2024" min="2020" max="2026">
            </div>
            <div class="filter-group">
              <label>ì¢…ë£Œ ì—°ë„</label>
              <input type="number" id="cohort-end-year" value="2026" min="2020" max="2026">
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn btn-primary" onclick="runCohortAnalysis()">ë¶„ì„ ì‹¤í–‰</button>
            <button class="btn btn-secondary" onclick="exportCSV('cohort')">CSV ë‚´ë³´ë‚´ê¸°</button>
          </div>
        </div>

        <!-- ì°¨íŠ¸ -->
        <div class="chart-container">
          <canvas id="cohort-chart"></canvas>
        </div>

        <!-- ë°ì´í„° í…Œì´ë¸” -->
        <div class="data-table-container">
          <table id="cohort-table">
            <thead>
              <tr>
                <th>ì½”í˜¸íŠ¸</th>
                <th>í•™ìƒ ìˆ˜</th>
                <th>ì§€í‘œ ê°’</th>
                <th>ì„¤ëª…</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- íŠ¸ë Œë“œ ë¶„ì„ íƒ­ -->
      <div id="trend-tab" class="tab-content">
        <h2>íŠ¸ë Œë“œ ë¶„ì„</h2>
        <p style="margin-bottom: 20px; color: #666;">ì‹œê³„ì—´ ë°ì´í„° ì¶”ì´ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>

        <!-- í•„í„° -->
        <div class="filters">
          <div class="filter-row">
            <div class="filter-group">
              <label>ê¸°ê°„ ë‹¨ìœ„</label>
              <select id="trend-period">
                <option value="monthly">ì›”ë³„</option>
                <option value="quarterly">ë¶„ê¸°ë³„</option>
                <option value="yearly">ì—°ë„ë³„</option>
              </select>
            </div>
            <div class="filter-group">
              <label>ë¶„ì„ ì§€í‘œ</label>
              <select id="trend-metric">
                <option value="new_students">ì‹ ê·œ í•™ìƒ ìˆ˜</option>
                <option value="topik_pass_rate">TOPIK í•©ê²©ë¥ </option>
                <option value="consult_frequency">ìƒë‹´ ë¹ˆë„</option>
              </select>
            </div>
            <div class="filter-group">
              <label>ì‹œì‘ ë‚ ì§œ</label>
              <input type="date" id="trend-start-date" value="2024-01-01">
            </div>
            <div class="filter-group">
              <label>ì¢…ë£Œ ë‚ ì§œ</label>
              <input type="date" id="trend-end-date" value="2024-12-31">
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn btn-primary" onclick="runTrendAnalysis()">ë¶„ì„ ì‹¤í–‰</button>
            <button class="btn btn-secondary" onclick="exportCSV('trend')">CSV ë‚´ë³´ë‚´ê¸°</button>
          </div>
        </div>

        <!-- Summary -->
        <div class="summary" id="trend-summary"></div>

        <!-- ì°¨íŠ¸ -->
        <div class="chart-container">
          <canvas id="trend-chart"></canvas>
        </div>

        <!-- ë°ì´í„° í…Œì´ë¸” -->
        <div class="data-table-container">
          <table id="trend-table">
            <thead>
              <tr>
                <th>ê¸°ê°„</th>
                <th>ê°’</th>
                <th>ë³€í™”ìœ¨</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ê¹”ë•Œê¸° ë¶„ì„ íƒ­ -->
      <div id="funnel-tab" class="tab-content">
        <h2>ê¹”ë•Œê¸° ë¶„ì„</h2>
        <p style="margin-bottom: 20px; color: #666;">í•™ìƒì˜ ë‹¨ê³„ë³„ ì „í™˜ìœ¨ì„ ë¶„ì„í•©ë‹ˆë‹¤ (ë“±ë¡ â†’ TOPIK â†’ ëŒ€í•™ ì…í•™).</p>

        <!-- í•„í„° -->
        <div class="filters">
          <div class="filter-row">
            <div class="filter-group">
              <label>ì‹œì‘ ë‚ ì§œ</label>
              <input type="date" id="funnel-start-date" value="2024-01-01">
            </div>
            <div class="filter-group">
              <label>ì¢…ë£Œ ë‚ ì§œ</label>
              <input type="date" id="funnel-end-date" value="2024-12-31">
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn btn-primary" onclick="runFunnelAnalysis()">ë¶„ì„ ì‹¤í–‰</button>
            <button class="btn btn-secondary" onclick="exportCSV('funnel')">CSV ë‚´ë³´ë‚´ê¸°</button>
          </div>
        </div>

        <!-- Insights -->
        <div class="summary" id="funnel-insights"></div>

        <!-- ì°¨íŠ¸ -->
        <div class="chart-container">
          <canvas id="funnel-chart"></canvas>
        </div>

        <!-- ë°ì´í„° í…Œì´ë¸” -->
        <div class="data-table-container">
          <table id="funnel-table">
            <thead>
              <tr>
                <th>ë‹¨ê³„</th>
                <th>í•™ìƒ ìˆ˜</th>
                <th>ì „í™˜ìœ¨</th>
                <th>ì´íƒˆë¥ </th>
                <th>ì´íƒˆ í•™ìƒ ìˆ˜</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ì‚¬ìš©ì ì •ì˜ ë¦¬í¬íŠ¸ íƒ­ -->
      <div id="report-tab" class="tab-content">
        <h2>ì‚¬ìš©ì ì •ì˜ ë¦¬í¬íŠ¸</h2>
        <p style="margin-bottom: 20px; color: #666;">ì›í•˜ëŠ” ì„¹ì…˜ì„ ì„ íƒí•˜ì—¬ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

        <!-- í•„í„° -->
        <div class="filters">
          <div class="filter-row">
            <div class="filter-group">
              <label>ë¦¬í¬íŠ¸ í…œí”Œë¦¿</label>
              <select id="report-template" onchange="updateReportDates()">
                <option value="weekly">ì£¼ê°„ ë¦¬í¬íŠ¸ (ìµœê·¼ 7ì¼)</option>
                <option value="monthly">ì›”ê°„ ë¦¬í¬íŠ¸ (ìµœê·¼ 30ì¼)</option>
                <option value="custom">ì‚¬ìš©ì ì •ì˜</option>
              </select>
            </div>
            <div class="filter-group">
              <label>ì‹œì‘ ë‚ ì§œ</label>
              <input type="date" id="report-start-date">
            </div>
            <div class="filter-group">
              <label>ì¢…ë£Œ ë‚ ì§œ</label>
              <input type="date" id="report-end-date">
            </div>
          </div>

          <div class="filter-row">
            <div class="filter-group">
              <label>
                <input type="checkbox" id="include-cohort" checked> ì½”í˜¸íŠ¸ ë¶„ì„ í¬í•¨
              </label>
            </div>
            <div class="filter-group">
              <label>
                <input type="checkbox" id="include-trend" checked> íŠ¸ë Œë“œ ë¶„ì„ í¬í•¨
              </label>
            </div>
            <div class="filter-group">
              <label>
                <input type="checkbox" id="include-funnel" checked> ê¹”ë•Œê¸° ë¶„ì„ í¬í•¨
              </label>
            </div>
            <div class="filter-group">
              <label>
                <input type="checkbox" id="include-students"> í•™ìƒ ëª©ë¡ í¬í•¨
              </label>
            </div>
          </div>

          <div class="filter-actions">
            <button class="btn btn-primary" onclick="generateReport()">ë¦¬í¬íŠ¸ ìƒì„±</button>
            <button class="btn btn-danger" onclick="exportPDF()">PDF ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>

        <!-- ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸° -->
        <div id="report-preview"></div>
      </div>
    </div>
  </div>

  <script>
    // ==================== ì „ì—­ ë³€ìˆ˜ ====================
    let currentTab = 'cohort';
    let currentData = {
      cohort: null,
      trend: null,
      funnel: null,
      report: null
    };
    let charts = {
      cohort: null,
      trend: null,
      funnel: null
    };

    // ==================== ì´ˆê¸°í™” ====================
    window.onload = function() {
      // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('trend-end-date').value = today;
      document.getElementById('funnel-end-date').value = today;
      updateReportDates();

      // ì´ˆê¸° ë¶„ì„ ì‹¤í–‰ (ì„ íƒì )
      // runCohortAnalysis();
    };

    // ==================== íƒ­ ì „í™˜ ====================
    function switchTab(tab) {
      // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
      const buttons = document.querySelectorAll('.tab-btn');
      buttons.forEach(btn => btn.classList.remove('active'));

      // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
      const contents = document.querySelectorAll('.tab-content');
      contents.forEach(content => content.classList.remove('active'));

      // ì„ íƒí•œ íƒ­ í™œì„±í™”
      event.target.classList.add('active');
      document.getElementById(tab + '-tab').classList.add('active');
      currentTab = tab;
    }

    // ==================== ë¡œë”© ë° ë©”ì‹œì§€ ====================
    function showLoading() {
      document.getElementById('loading').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('active');
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.classList.add('active');
      setTimeout(() => errorEl.classList.remove('active'), 5000);
    }

    function showSuccess(message) {
      const successEl = document.getElementById('successMessage');
      successEl.textContent = message;
      successEl.classList.add('active');
      setTimeout(() => successEl.classList.remove('active'), 3000);
    }

    // ==================== ì½”í˜¸íŠ¸ ë¶„ì„ ====================
    function runCohortAnalysis() {
      showLoading();

      const filters = {
        cohortType: document.getElementById('cohort-type').value,
        metric: document.getElementById('cohort-metric').value,
        startYear: parseInt(document.getElementById('cohort-start-year').value),
        endYear: parseInt(document.getElementById('cohort-end-year').value)
      };

      const sessionId = getSessionId();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            currentData.cohort = result.data;
            renderCohortChart(result.data);
            renderCohortTable(result.data);
            showSuccess('ì½”í˜¸íŠ¸ ë¶„ì„ ì™„ë£Œ!');
          } else {
            showError('ì—ëŸ¬: ' + (result.errorKey || result.error));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('ì„œë²„ ì˜¤ë¥˜: ' + error.message);
        })
        .getCohortAnalysis(sessionId, filters);
    }

    function renderCohortChart(data) {
      const ctx = document.getElementById('cohort-chart').getContext('2d');

      // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ
      if (charts.cohort) {
        charts.cohort.destroy();
      }

      charts.cohort = new Chart(ctx, {
        type: 'bar',
        data: data.chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            title: {
              display: true,
              text: 'ì½”í˜¸íŠ¸ë³„ ì§€í‘œ ë¹„êµ'
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function renderCohortTable(data) {
      const tbody = document.querySelector('#cohort-table tbody');
      tbody.innerHTML = '';

      data.cohorts.forEach(cohort => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = cohort.cohortName;
        row.insertCell(1).textContent = cohort.studentCount;
        row.insertCell(2).textContent = cohort.metricValue.toFixed(2);
        row.insertCell(3).textContent = cohort.metricLabel;
      });
    }

    // ==================== íŠ¸ë Œë“œ ë¶„ì„ ====================
    function runTrendAnalysis() {
      showLoading();

      const params = {
        period: document.getElementById('trend-period').value,
        metric: document.getElementById('trend-metric').value,
        startDate: document.getElementById('trend-start-date').value,
        endDate: document.getElementById('trend-end-date').value
      };

      const sessionId = getSessionId();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            currentData.trend = result.data;
            renderTrendSummary(result.data.summary);
            renderTrendChart(result.data);
            renderTrendTable(result.data);
            showSuccess('íŠ¸ë Œë“œ ë¶„ì„ ì™„ë£Œ!');
          } else {
            showError('ì—ëŸ¬: ' + (result.errorKey || result.error));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('ì„œë²„ ì˜¤ë¥˜: ' + error.message);
        })
        .getTrendAnalysis(sessionId, params);
    }

    function renderTrendSummary(summary) {
      const container = document.getElementById('trend-summary');
      container.innerHTML = `
        <div class="summary-card">
          <h3>í‰ê· </h3>
          <p>${summary.average.toFixed(2)}</p>
        </div>
        <div class="summary-card">
          <h3>ìµœì†Œ</h3>
          <p>${summary.min}</p>
        </div>
        <div class="summary-card">
          <h3>ìµœëŒ€</h3>
          <p>${summary.max}</p>
        </div>
        <div class="summary-card">
          <h3>ì´ ì„±ì¥ë¥ </h3>
          <p>${summary.totalGrowth.toFixed(1)}%</p>
        </div>
      `;
    }

    function renderTrendChart(data) {
      const ctx = document.getElementById('trend-chart').getContext('2d');

      if (charts.trend) {
        charts.trend.destroy();
      }

      charts.trend = new Chart(ctx, {
        type: 'line',
        data: data.chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            title: {
              display: true,
              text: 'ì‹œê³„ì—´ ì¶”ì´ ë¶„ì„'
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function renderTrendTable(data) {
      const tbody = document.querySelector('#trend-table tbody');
      tbody.innerHTML = '';

      data.trends.forEach(trend => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = trend.periodLabel;
        row.insertCell(1).textContent = trend.value.toFixed(2);
        row.insertCell(2).textContent = trend.changeLabel;
      });
    }

    // ==================== ê¹”ë•Œê¸° ë¶„ì„ ====================
    function runFunnelAnalysis() {
      showLoading();

      const params = {
        startDate: document.getElementById('funnel-start-date').value,
        endDate: document.getElementById('funnel-end-date').value
      };

      const sessionId = getSessionId();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            currentData.funnel = result.data;
            renderFunnelInsights(result.data.insights);
            renderFunnelChart(result.data);
            renderFunnelTable(result.data);
            showSuccess('ê¹”ë•Œê¸° ë¶„ì„ ì™„ë£Œ!');
          } else {
            showError('ì—ëŸ¬: ' + (result.errorKey || result.error));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('ì„œë²„ ì˜¤ë¥˜: ' + error.message);
        })
        .getFunnelAnalysis(sessionId, params);
    }

    function renderFunnelInsights(insights) {
      const container = document.getElementById('funnel-insights');
      container.innerHTML = `
        <div class="summary-card">
          <h3>ì „ì²´ ì „í™˜ìœ¨</h3>
          <p>${insights.overallConversion.toFixed(2)}%</p>
        </div>
        <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
          <h3>Bottleneck</h3>
          <p>${getStageLabelKR(insights.bottleneck)}</p>
        </div>
      `;
    }

    function renderFunnelChart(data) {
      const ctx = document.getElementById('funnel-chart').getContext('2d');

      if (charts.funnel) {
        charts.funnel.destroy();
      }

      charts.funnel = new Chart(ctx, {
        type: 'bar',
        data: data.chartData,
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            title: {
              display: true,
              text: 'ë‹¨ê³„ë³„ ì „í™˜ ê¹”ë•Œê¸°'
            }
          },
          scales: {
            x: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function renderFunnelTable(data) {
      const tbody = document.querySelector('#funnel-table tbody');
      tbody.innerHTML = '';

      data.funnel.forEach(stage => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = stage.stageLabel;
        row.insertCell(1).textContent = stage.count;
        row.insertCell(2).textContent = stage.conversionRate.toFixed(2) + '%';
        row.insertCell(3).textContent = stage.dropoffRate.toFixed(2) + '%';
        row.insertCell(4).textContent = stage.dropoffCount;
      });
    }

    // ==================== ì‚¬ìš©ì ì •ì˜ ë¦¬í¬íŠ¸ ====================
    function updateReportDates() {
      const template = document.getElementById('report-template').value;
      const today = new Date();
      const endDate = today.toISOString().split('T')[0];
      let startDate;

      if (template === 'weekly') {
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        startDate = weekAgo.toISOString().split('T')[0];
      } else if (template === 'monthly') {
        const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
        startDate = monthAgo.toISOString().split('T')[0];
      } else {
        startDate = '2024-01-01';
      }

      document.getElementById('report-start-date').value = startDate;
      document.getElementById('report-end-date').value = endDate;
    }

    function generateReport() {
      showLoading();

      const config = {
        template: document.getElementById('report-template').value,
        filters: {
          dateFrom: document.getElementById('report-start-date').value,
          dateTo: document.getElementById('report-end-date').value,
          includeCohort: document.getElementById('include-cohort').checked,
          includeTrend: document.getElementById('include-trend').checked,
          includeFunnel: document.getElementById('include-funnel').checked,
          includeStudentList: document.getElementById('include-students').checked
        },
        format: 'html'
      };

      const sessionId = getSessionId();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            currentData.report = result.data;
            renderReportPreview(result.data);
            showSuccess('ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ!');
          } else {
            showError('ì—ëŸ¬: ' + (result.errorKey || result.error));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('ì„œë²„ ì˜¤ë¥˜: ' + error.message);
        })
        .generateCustomReport(sessionId, config);
    }

    function renderReportPreview(data) {
      const container = document.getElementById('report-preview');
      let html = `
        <div style="border: 2px solid #ddd; padding: 20px; border-radius: 8px; margin-top: 20px; background: white;">
          <h3>${data.reportName}</h3>
          <p style="color: #666;">Report ID: ${data.reportId}</p>
          <p style="color: #666;">ìƒì„±ì¼ì‹œ: ${new Date(data.generatedAt).toLocaleString('ko-KR')}</p>
          <hr style="margin: 20px 0;">
      `;

      data.sections.forEach(section => {
        html += `<h4 style="margin-top: 20px;">${section.sectionTitle}</h4>`;
        html += `<p style="color: #666; font-size: 14px;">ì„¹ì…˜ íƒ€ì…: ${section.sectionType}</p>`;
        // ê°„ë‹¨í•œ ë¯¸ë¦¬ë³´ê¸° (ì‹¤ì œ ë°ì´í„°ëŠ” PDFë¡œ í™•ì¸)
      });

      html += '</div>';
      container.innerHTML = html;
    }

    function exportPDF() {
      if (!currentData.report) {
        showError('ë¨¼ì € ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
        return;
      }

      showLoading();
      const sessionId = getSessionId();

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showSuccess('PDF ìƒì„± ì™„ë£Œ! ë‹¤ìš´ë¡œë“œ ë§í¬: ' + result.data.fileUrl);
            window.open(result.data.fileUrl, '_blank');
          } else {
            showError('ì—ëŸ¬: ' + (result.errorKey || result.error));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('ì„œë²„ ì˜¤ë¥˜: ' + error.message);
        })
        .exportReportToPDF(sessionId, currentData.report);
    }

    // ==================== CSV ë‚´ë³´ë‚´ê¸° ====================
    function exportCSV(type) {
      const data = currentData[type];
      if (!data) {
        showError('ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        return;
      }

      let csv = '';
      let filename = '';

      if (type === 'cohort') {
        csv = 'Cohort,StudentCount,MetricValue,MetricLabel\n';
        data.cohorts.forEach(row => {
          csv += `"${row.cohortName}",${row.studentCount},${row.metricValue},"${row.metricLabel}"\n`;
        });
        filename = 'cohort_analysis.csv';
      } else if (type === 'trend') {
        csv = 'Period,Value,Change\n';
        data.trends.forEach(row => {
          csv += `"${row.periodLabel}",${row.value},"${row.changeLabel}"\n`;
        });
        filename = 'trend_analysis.csv';
      } else if (type === 'funnel') {
        csv = 'Stage,Count,ConversionRate,DropoffRate,DropoffCount\n';
        data.funnel.forEach(row => {
          csv += `"${row.stageLabel}",${row.count},${row.conversionRate},${row.dropoffRate},${row.dropoffCount}\n`;
        });
        filename = 'funnel_analysis.csv';
      }

      downloadCSV(csv, filename);
      showSuccess('CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ==================== ìœ í‹¸ë¦¬í‹° ====================
    function getSessionId() {
      // ì‹¤ì œ êµ¬í˜„ ì‹œ CacheServiceì—ì„œ ì„¸ì…˜ ID ê°€ì ¸ì˜¤ê¸°
      // í˜„ì¬ëŠ” í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ í•˜ë“œì½”ë”©
      return 'test-session-id';
    }

    function getStageLabelKR(stage) {
      const labels = {
        'enrollment': 'ë“±ë¡',
        'topik_3plus': 'TOPIK 3ê¸‰ ì´ìƒ',
        'university_admission': 'ëŒ€í•™ ì…í•™'
      };
      return labels[stage] || stage;
    }
  </script>
</body>
</html>
