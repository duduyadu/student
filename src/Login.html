<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; }

    /* Login View */
    .login-container { max-width: 400px; margin: 100px auto; padding: 40px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-bottom: 30px; color: #333; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
    input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    input:focus { outline: none; border-color: #4CAF50; }
    .btn-primary { width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
    .btn-primary:hover { background: #45a049; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .error { color: red; text-align: center; margin-top: 10px; display: none; }
    .success { color: #4CAF50; text-align: center; margin-top: 10px; display: none; font-weight: 600; }
    .loading { display: none; text-align: center; margin-top: 10px; color: #666; }
    .lang-toggle { text-align: right; margin-bottom: 20px; }
    .lang-btn { background: none; border: none; color: #2196F3; cursor: pointer; text-decoration: underline; padding: 0 5px; font-size: 14px; }

    /* íšŒì›ê°€ì…/ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ë§í¬ */
    .signup-link, .forgot-password-link { text-align: center; margin-top: 15px; font-size: 14px; }
    .signup-link p { color: #666; }
    .signup-link a, .forgot-password-link a { color: #2196F3; text-decoration: none; }
    .signup-link a:hover, .forgot-password-link a:hover { text-decoration: underline; }

    /* Main App View */
    #app-view { display: none; }
    .header { background: #4CAF50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { color: white; margin: 0; font-size: 20px; text-align: left; }
    .header-right { display: flex; align-items: center; gap: 15px; }
    .user-info { font-size: 14px; }
    .btn-lang { padding: 6px 12px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-lang:hover { background: rgba(255,255,255,0.3); }
    .btn-logout { padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); border-radius: 4px; cursor: pointer; font-size: 13px; }
    .btn-logout:hover { background: rgba(255,255,255,0.3); }
    .app-container { max-width: 1400px; margin: 20px auto; padding: 20px; }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
    .tab-btn { padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 15px; color: #666; transition: all 0.3s; white-space: pre-line; text-align: center; line-height: 1.4; }
    .tab-btn.active { color: #4CAF50; border-bottom-color: #4CAF50; font-weight: 600; }
    .tab-btn:hover { color: #4CAF50; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* í•™ìƒ ê´€ë¦¬ ì„¹ì…˜ */
    .student-section { padding: 20px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .section-header h2 { margin: 0; color: #333; }

    /* ê²€ìƒ‰ ë°” */
    .search-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .search-bar input { flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    .search-bar select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    .btn-search { padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .btn-search:hover { background: #45a049; }

    /* í…Œì´ë¸” */
    .table-container { overflow-x: auto; }
    .student-table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .student-table thead { background: #4CAF50; color: white; }
    .student-table th { padding: 12px; text-align: left; font-weight: 600; }
    .student-table td { padding: 12px; border-bottom: 1px solid #eee; }
    .student-table tbody tr:hover { background: #f5f5f5; }
    .actions { display: flex; gap: 5px; }
    .btn-sm { padding: 5px 10px; font-size: 13px; border: none; border-radius: 3px; cursor: pointer; }
    .btn-edit { background: #2196F3; color: white; }
    .btn-edit:hover { background: #0b7dda; }
    .btn-delete { background: #f44336; color: white; }
    .btn-delete:hover { background: #da190b; }

    /* í˜ì´ì§€ë„¤ì´ì…˜ */
    .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 20px; }
    .pagination button { padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 3px; }
    .pagination button.active { background: #4CAF50; color: white; border-color: #4CAF50; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ëª¨ë‹¬ */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; }
    .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { position: relative; max-width: 800px; max-height: 90vh; margin: 50px auto; background: white; border-radius: 8px; overflow-y: auto; padding: 30px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #999; }

    /* í¼ */
    .form-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
    .form-section:last-of-type { border-bottom: none; }
    .form-section h3 { margin: 0 0 15px 0; color: #555; font-size: 16px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 14px; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .btn-secondary { padding: 10px 20px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 15px; }

    /* ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ */
    .confirm-dialog { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; }
    .dialog-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .dialog-content { position: relative; max-width: 400px; margin: 200px auto; background: white; border-radius: 8px; padding: 30px; }
    .dialog-content h3 { margin: 0 0 15px 0; color: #333; }
    .dialog-content p { color: #666; margin-bottom: 10px; }
    .student-name { font-weight: 600; color: #333; font-size: 16px; }
    .dialog-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .btn-danger { padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .btn-danger:hover { background: #da190b; }

    /* ë¡œë”©/ë©”ì‹œì§€ */
    #student-loading { text-align: center; padding: 40px; color: #666; display: none; }
    .no-data { text-align: center; padding: 40px; color: #999; display: none; }

    /* ë°˜ì‘í˜• - íƒœë¸”ë¦¿ */
    @media (max-width: 1024px) {
      .app-container { padding: 10px; }
      .student-section { padding: 10px; }
    }

    /* ë°˜ì‘í˜• - ëª¨ë°”ì¼ */
    @media (max-width: 768px) {
      /* í—¤ë” */
      .header { flex-direction: column; gap: 10px; padding: 10px; }
      .header h1 { font-size: 16px; text-align: center; }
      .header-right { flex-wrap: wrap; justify-content: center; }
      .btn-lang { padding: 4px 8px; font-size: 11px; }
      .btn-logout { padding: 6px 12px; font-size: 12px; }

      /* ê²€ìƒ‰ ë°” */
      .search-bar { flex-direction: column; }
      .search-bar input { min-width: 100%; }
      .search-bar select { width: 100%; }
      .btn-search { width: 100%; }

      /* ì„¹ì…˜ í—¤ë” */
      .section-header { flex-direction: column; gap: 10px; align-items: stretch; }
      .section-header h2 { font-size: 18px; text-align: center; }
      .btn-primary { width: 100%; }

      /* í…Œì´ë¸” */
      .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .student-table { font-size: 12px; min-width: 800px; }
      .student-table th, .student-table td { padding: 6px 4px; white-space: nowrap; }
      .actions { flex-direction: column; gap: 3px; }
      .btn-sm { width: 100%; font-size: 11px; padding: 4px 8px; }

      /* í˜ì´ì§€ë„¤ì´ì…˜ */
      .pagination button { padding: 6px 10px; font-size: 12px; }

      /* í¼ */
      .form-row { grid-template-columns: 1fr; }
      .form-group label { font-size: 13px; }
      .form-group input, .form-group select { font-size: 13px; padding: 8px; }

      /* ëª¨ë‹¬ */
      .modal-content {
        margin: 10px;
        padding: 15px;
        max-height: 95vh;
        border-radius: 4px;
      }
      .modal-header h2 { font-size: 16px; }
      .modal-close { font-size: 24px; }
      .form-section h3 { font-size: 14px; }
      .form-actions { flex-direction: column; }
      .form-actions button { width: 100%; }

      /* ë‹¤ì´ì–¼ë¡œê·¸ */
      .dialog-content {
        margin: 20px;
        padding: 20px;
      }
      .dialog-content h3 { font-size: 16px; }
      .dialog-actions { flex-direction: column; }
      .dialog-actions button { width: 100%; }

      /* ë¡œë”©/ë©”ì‹œì§€ */
      #student-loading, .no-data { padding: 20px; font-size: 14px; }
    }

    /* ë°˜ì‘í˜• - ì‘ì€ ëª¨ë°”ì¼ */
    @media (max-width: 480px) {
      .header h1 { font-size: 14px; }
      .section-header h2 { font-size: 16px; }
      .student-table { font-size: 11px; min-width: 700px; }
      .modal-content { margin: 5px; padding: 10px; }
      .form-group label { font-size: 12px; }
      .form-group input, .form-group select { font-size: 12px; padding: 6px; }
    }
  </style>
</head>
<body>

  <!-- LOGIN VIEW -->
  <div id="login-view">
    <div class="login-container">
      <div class="lang-toggle">
        <button class="lang-btn" onclick="switchLanguage('ko')">í•œêµ­ì–´</button> |
        <button class="lang-btn" onclick="switchLanguage('vi')">Ti&#7871;ng Vi&#7879;t</button>
      </div>

      <h1 data-i18n="title_login">ë¡œê·¸ì¸</h1>

      <form onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="user-type" data-i18n="login_usertype_label">ì‚¬ìš©ì ìœ í˜•</label>
          <select id="user-type" required>
            <option value="student" data-i18n="option_usertype_student">í•™ìƒ</option>
            <option value="agency" data-i18n="option_usertype_agency">ìœ í•™ì› ê´€ë¦¬ì</option>
            <option value="master" data-i18n="option_usertype_master">ì‹œìŠ¤í…œ ê´€ë¦¬ì</option>
          </select>
        </div>

        <div class="form-group">
          <label data-i18n="label_login_id">ë¡œê·¸ì¸ ID</label>
          <input type="text" id="login-id" data-placeholder-i18n="placeholder_login_id" required>
        </div>

        <div class="form-group">
          <label data-i18n="label_password">ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="password" data-placeholder-i18n="placeholder_password" required>
        </div>

        <button type="submit" id="login-btn" class="btn-primary" data-i18n="btn_login">ë¡œê·¸ì¸</button>
      </form>

      <div class="signup-link">
        <p><span data-i18n="login_signup_link">ì•„ì§ ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?</span> <a href="SignUp.html" data-i18n="btn_signup">íšŒì›ê°€ì…</a></p>
      </div>

      <div class="forgot-password-link">
        <a href="ForgotPassword.html" data-i18n="login_forgot_password">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</a>
      </div>

      <div class="loading" id="loading" data-i18n="msg_logging_in">ë¡œê·¸ì¸ ì¤‘...</div>
      <div class="success" id="success" data-i18n="msg_login_success">ë¡œê·¸ì¸ ì„±ê³µ!</div>
      <div class="error" id="error"></div>
    </div>
  </div>

  <!-- APP VIEW (shown after login) -->
  <div id="app-view">
    <div class="header">
      <h1>AJU E&J í•™ìƒê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
      <div class="header-right">
        <span class="user-info" id="user-info"></span>
        <button class="btn-lang" onclick="switchLanguage('ko')" data-i18n="btn_lang_ko">í•œêµ­ì–´</button>
        <button class="btn-lang" onclick="switchLanguage('vi')" data-i18n="btn_lang_vi">Tiáº¿ng Viá»‡t</button>
        <button class="btn-logout" onclick="handleLogout()" data-i18n="btn_logout">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="app-container">
      <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ (masterë§Œ ìœ í•™ì› ê´€ë¦¬ íƒ­ í‘œì‹œ) -->
      <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('student')" data-i18n="tab_student_management">í•™ìƒ
ê´€ë¦¬</button>
        <button class="tab-btn" id="agency-tab-btn" onclick="switchTab('agency')" data-i18n="tab_agency_management" style="display:none;">ìœ í•™ì›
ê´€ë¦¬</button>
      </div>

      <!-- í•™ìƒ ê´€ë¦¬ íƒ­ -->
      <div id="student-tab" class="tab-content active">
        <div class="student-section">
        <div class="section-header">
          <h2 data-i18n="title_student_management">í•™ìƒ ê´€ë¦¬</h2>
          <button class="btn-primary" onclick="showCreateForm()" data-i18n="btn_add_student">
            + í•™ìƒ ë“±ë¡
          </button>
        </div>

        <!-- ê²€ìƒ‰/í•„í„° ë°” -->
        <div class="search-bar">
          <input
            type="text"
            id="search-input"
            data-placeholder-i18n="placeholder_search_student"
            placeholder="ì´ë¦„, í•™ìƒIDë¡œ ê²€ìƒ‰..."
            onkeyup="handleSearchKeyup(event)"
          >
          <button class="btn-search" onclick="searchStudents()" data-i18n="btn_search">ê²€ìƒ‰</button>

          <select id="sort-select" onchange="sortStudents()">
            <option value="EnrollmentDate-desc" data-i18n="sort_newest">ìµœì‹  ë“±ë¡ìˆœ</option>
            <option value="EnrollmentDate-asc" data-i18n="sort_oldest">ì˜¤ë˜ëœ ìˆœ</option>
            <option value="NameKR-asc" data-i18n="sort_name_asc">ì´ë¦„ ê°€ë‚˜ë‹¤ìˆœ</option>
          </select>
        </div>

        <!-- í•™ìƒ ëª©ë¡ í…Œì´ë¸” -->
        <div class="table-container">
          <table class="student-table">
            <thead>
              <tr>
                <th data-i18n="label_student_id">í•™ìƒ ID</th>
                <th data-i18n="label_name_kr">í•œêµ­ ì´ë¦„</th>
                <th data-i18n="label_name_vn">ë² íŠ¸ë‚¨ ì´ë¦„</th>
                <th data-i18n="label_dob">ìƒë…„ì›”ì¼</th>
                <th data-i18n="label_gender">ì„±ë³„</th>
                <th data-i18n="label_agency">ìœ í•™ì›</th>
                <th data-i18n="label_phone_kr">ì—°ë½ì²˜</th>
                <th data-i18n="label_enrollment_date">ë“±ë¡ì¼</th>
                <th data-i18n="label_actions">ì‘ì—…</th>
              </tr>
            </thead>
            <tbody id="student-list">
              <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </tbody>
          </table>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div class="pagination" id="pagination">
          <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </div>

        <!-- ë¡œë”©/ë©”ì‹œì§€ -->
        <div id="student-loading">
          <span data-i18n="msg_loading">ë¡œë”© ì¤‘...</span>
        </div>
        <div class="no-data" id="no-data">
          <span data-i18n="msg_no_students">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</span>
        </div>
      </div>
    </div>

    <!-- ìœ í•™ì› ê´€ë¦¬ íƒ­ (master ì „ìš©) -->
    <div id="agency-tab" class="tab-content">
      <div class="agency-section">
        <div class="section-header">
          <h2 data-i18n="tab_agency_management">ìœ í•™ì› ê´€ë¦¬</h2>
          <button class="btn-primary" onclick="showCreateAgencyForm()" data-i18n="btn_add_agency">
            + ìœ í•™ì› ë“±ë¡
          </button>
        </div>

        <!-- ê²€ìƒ‰ ë°” -->
        <div class="search-bar">
          <input
            type="text"
            id="agency-search"
            data-placeholder-i18n="placeholder_search_agency"
            placeholder="ìœ í•™ì›ëª…, ì½”ë“œë¡œ ê²€ìƒ‰..."
            onkeyup="searchAgencies()"
          >
        </div>

        <!-- ìœ í•™ì› í…Œì´ë¸” -->
        <div class="table-container">
          <table id="agency-table" class="student-table">
            <thead>
              <tr>
                <th data-i18n="label_agency_code">ìœ í•™ì› ì½”ë“œ</th>
                <th data-i18n="label_agency_name">ìœ í•™ì›ëª…</th>
                <th data-i18n="label_login_id">ë¡œê·¸ì¸ ID</th>
                <th data-i18n="label_role">ì—­í• </th>
                <th data-i18n="label_created_at">ë“±ë¡ì¼</th>
                <th data-i18n="label_actions">ì‘ì—…</th>
              </tr>
            </thead>
            <tbody id="agency-table-body">
              <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </tbody>
          </table>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div class="pagination" id="agency-pagination">
          <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </div>

        <!-- ë¡œë”©/ë©”ì‹œì§€ -->
        <div id="agency-loading">
          <span data-i18n="msg_loading">ë¡œë”© ì¤‘...</span>
        </div>
        <div class="no-data" id="agency-no-data">
          <span data-i18n="msg_no_agencies">ë“±ë¡ëœ ìœ í•™ì›ì´ ì—†ìŠµë‹ˆë‹¤.</span>
        </div>
      </div>
    </div>

    <!-- í•™ìƒ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="student-form-modal" style="display:none;">
      <div class="modal-overlay" onclick="closeModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title" data-i18n="title_add_student">í•™ìƒ ë“±ë¡</h2>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>

        <form id="student-form" onsubmit="handleStudentSubmit(event)">
          <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
          <div class="form-section">
            <h3 data-i18n="section_basic_info">ê¸°ë³¸ ì •ë³´</h3>

            <div class="form-row">
              <div class="form-group">
                <label data-i18n="label_name_kr">í•œêµ­ ì´ë¦„ *</label>
                <input type="text" name="NameKR" required data-placeholder-i18n="placeholder_name_kr">
              </div>
              <div class="form-group">
                <label data-i18n="label_name_vn">ë² íŠ¸ë‚¨ ì´ë¦„ *</label>
                <input type="text" name="NameVN" required data-placeholder-i18n="placeholder_name_vn">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label data-i18n="label_dob">ìƒë…„ì›”ì¼ *</label>
                <input type="date" name="DOB" required>
              </div>
              <div class="form-group">
                <label data-i18n="label_gender">ì„±ë³„ *</label>
                <select name="Gender" required>
                  <option value="" data-i18n="option_select">ì„ íƒ</option>
                  <option value="M" data-i18n="option_male">ë‚¨ì„±</option>
                  <option value="F" data-i18n="option_female">ì—¬ì„±</option>
                </select>
              </div>
            </div>

            <div class="form-group" id="agency-select-group">
              <label data-i18n="label_agency">ìœ í•™ì› *</label>
              <select name="AgencyCode" required id="agency-select">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
              </select>
            </div>
          </div>

          <!-- ì—°ë½ì²˜ ì •ë³´ ì„¹ì…˜ -->
          <div class="form-section">
            <h3 data-i18n="section_contact_info">ì—°ë½ì²˜ ì •ë³´</h3>

            <div class="form-group">
              <label data-i18n="label_address_vn">ë² íŠ¸ë‚¨ ì£¼ì†Œ</label>
              <input type="text" name="HomeAddressVN" data-placeholder-i18n="placeholder_address_vn">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label data-i18n="label_phone_kr">í•œêµ­ ì—°ë½ì²˜</label>
                <input type="tel" name="PhoneKR" data-placeholder-i18n="placeholder_phone_kr">
              </div>
              <div class="form-group">
                <label data-i18n="label_phone_vn">ë² íŠ¸ë‚¨ ì—°ë½ì²˜</label>
                <input type="tel" name="PhoneVN" data-placeholder-i18n="placeholder_phone_vn">
              </div>
            </div>

            <div class="form-group">
              <label data-i18n="label_email">ì´ë©”ì¼</label>
              <input type="email" name="Email" data-placeholder-i18n="placeholder_email">
            </div>
          </div>

          <!-- í•™ë¶€ëª¨ ì •ë³´ ì„¹ì…˜ -->
          <div class="form-section">
            <h3 data-i18n="section_parent_info">í•™ë¶€ëª¨ ì •ë³´</h3>

            <div class="form-row">
              <div class="form-group">
                <label data-i18n="label_parent_name">í•™ë¶€ëª¨ ì´ë¦„</label>
                <input type="text" name="ParentNameVN" data-placeholder-i18n="placeholder_parent_name">
              </div>
              <div class="form-group">
                <label data-i18n="label_parent_phone">í•™ë¶€ëª¨ ì—°ë½ì²˜</label>
                <input type="tel" name="ParentPhoneVN" data-placeholder-i18n="placeholder_parent_phone">
              </div>
            </div>

            <div class="form-group">
              <label data-i18n="label_parent_economic">í•™ë¶€ëª¨ ê²½ì œ ìƒí™©</label>
              <select name="ParentEconomic">
                <option value="" data-i18n="option_select">ì„ íƒ</option>
                <option value="ìƒ" data-i18n="option_high">ìƒ</option>
                <option value="ì¤‘" data-i18n="option_medium">ì¤‘</option>
                <option value="í•˜" data-i18n="option_low">í•˜</option>
              </select>
            </div>
          </div>

          <!-- í•™ì—… ì •ë³´ ì„¹ì…˜ -->
          <div class="form-section">
            <h3 data-i18n="section_academic_info">í•™ì—… ì •ë³´</h3>

            <div class="form-row">
              <div class="form-group">
                <label data-i18n="label_high_school_gpa">ê³ ë“±í•™êµ ì„±ì </label>
                <input type="text" name="HighSchoolGPA" data-placeholder-i18n="placeholder_gpa">
              </div>
              <div class="form-group">
                <label data-i18n="label_enrollment_date">ë“±ë¡ì¼</label>
                <input type="date" name="EnrollmentDate">
              </div>
            </div>

            <div class="form-group">
              <label data-i18n="label_status">ìƒíƒœ</label>
              <select name="Status">
                <option value="ìœ í•™ì „" data-i18n="option_before_study">ìœ í•™ì „</option>
                <option value="ì–´í•™ì—°ìˆ˜" data-i18n="option_language_course">ì–´í•™ì—°ìˆ˜</option>
                <option value="ëŒ€í•™êµì¬í•™ì¤‘" data-i18n="option_enrolled">ëŒ€í•™êµì¬í•™ì¤‘</option>
                <option value="ì¡¸ì—…" data-i18n="option_graduated">ì¡¸ì—…</option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" data-i18n="btn_save">ì €ì¥</button>
            <button type="button" class="btn-secondary" onclick="closeModal()" data-i18n="btn_cancel">ì·¨ì†Œ</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ -->
    <div class="confirm-dialog" id="delete-confirm" style="display:none;">
      <div class="dialog-overlay" onclick="closeDeleteDialog()"></div>
      <div class="dialog-content">
        <h3 data-i18n="title_confirm_delete">ì‚­ì œ í™•ì¸</h3>
        <p data-i18n="msg_confirm_delete">ì •ë§ë¡œ ì´ í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p class="student-name" id="delete-student-name"></p>
        <div class="dialog-actions">
          <button class="btn-danger" onclick="confirmDelete()" data-i18n="btn_delete">ì‚­ì œ</button>
          <button class="btn-secondary" onclick="closeDeleteDialog()" data-i18n="btn_cancel">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>

    <!-- ìœ í•™ì› ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="agency-form-modal" style="display:none;">
      <div class="modal-overlay" onclick="closeAgencyModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="agency-modal-title" data-i18n="title_add_agency">ìœ í•™ì› ë“±ë¡</h2>
          <button class="modal-close" onclick="closeAgencyModal()">&times;</button>
        </div>

        <form id="agency-form" onsubmit="handleAgencySubmit(event)">
          <div class="form-section">
            <div class="form-group">
              <label data-i18n="label_agency_code">ìœ í•™ì› ì½”ë“œ *</label>
              <input type="text" name="AgencyCode" required id="agency-code-input" data-placeholder-i18n="placeholder_agency_code">
            </div>

            <div class="form-group">
              <label data-i18n="label_agency_name">ìœ í•™ì›ëª… *</label>
              <input type="text" name="AgencyName" required data-placeholder-i18n="placeholder_agency_name">
            </div>

            <div class="form-group">
              <label data-i18n="label_login_id">ë¡œê·¸ì¸ ID *</label>
              <input type="text" name="LoginID" required data-placeholder-i18n="placeholder_login_id">
            </div>

            <div class="form-group">
              <label data-i18n="label_password">ë¹„ë°€ë²ˆí˜¸ *</label>
              <input type="password" name="Password" id="agency-password-input" data-placeholder-i18n="placeholder_password">
            </div>

            <div class="form-group">
              <label data-i18n="label_role">ì—­í•  *</label>
              <select name="Role" required>
                <option value="agency" data-i18n="option_role_agency">ìœ í•™ì›</option>
                <option value="branch" data-i18n="option_role_branch">í•œêµ­ ì§€ì </option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" data-i18n="btn_save">ì €ì¥</button>
            <button type="button" class="btn-secondary" onclick="closeAgencyModal()" data-i18n="btn_cancel">ì·¨ì†Œ</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ìœ í•™ì› ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ -->
    <div class="confirm-dialog" id="agency-delete-confirm" style="display:none;">
      <div class="dialog-overlay" onclick="closeAgencyDeleteDialog()"></div>
      <div class="dialog-content">
        <h3 data-i18n="title_confirm_delete">ì‚­ì œ í™•ì¸</h3>
        <p data-i18n="msg_confirm_delete_agency">ì •ë§ë¡œ ì´ ìœ í•™ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p class="agency-name" id="delete-agency-name"></p>
        <div class="dialog-actions">
          <button class="btn-danger" onclick="confirmAgencyDelete()" data-i18n="btn_delete">ì‚­ì œ</button>
          <button class="btn-secondary" onclick="closeAgencyDeleteDialog()" data-i18n="btn_cancel">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== ì „ì—­ ë³€ìˆ˜ ====================
    var currentSessionId = null;
    var currentUser = null;
    var currentLang = 'ko';
    var i18n = {};
    var studentList = [];          // ì „ì²´ í•™ìƒ ëª©ë¡
    var currentPage = 1;           // í˜„ì¬ í˜ì´ì§€
    var itemsPerPage = 20;         // í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜
    var currentFilters = {};       // í˜„ì¬ í•„í„° ì¡°ê±´
    var editingStudentId = null;   // ìˆ˜ì • ì¤‘ì¸ í•™ìƒ ID
    var deletingStudentId = null;  // ì‚­ì œ ëŒ€ìƒ í•™ìƒ ID

    // ìœ í•™ì› ê´€ë¦¬ ê´€ë ¨ ë³€ìˆ˜
    var agencyList = [];           // ì „ì²´ ìœ í•™ì› ëª©ë¡
    var currentAgencyPage = 1;     // í˜„ì¬ í˜ì´ì§€
    var agencyItemsPerPage = 20;   // í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜
    var editingAgencyCode = null;  // ìˆ˜ì • ì¤‘ì¸ ìœ í•™ì› ì½”ë“œ
    var deletingAgencyCode = null; // ì‚­ì œ ëŒ€ìƒ ìœ í•™ì› ì½”ë“œ

    // ========================================
    // ì´ˆê¸°í™”
    // ========================================
    window.onload = function() {
      loadI18n('ko');

      // sessionStorageì—ì„œ ì„¸ì…˜ ë³µì› ì‹œë„
      var savedSessionId = sessionStorage.getItem('sessionId');
      var savedUser = sessionStorage.getItem('user');

      if (savedSessionId && savedUser) {
        // ì„œë²„ì—ì„œ ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸
        google.script.run
          .withSuccessHandler(function(response) {
            // response null ë°©ì–´
            if (!response) {
              console.error('checkSession returned null/undefined');
              clearSession();
              showLoginView();
              return;
            }

            if (response.success) {
              currentSessionId = savedSessionId;
              currentUser = JSON.parse(savedUser);
              showAppView();
            } else {
              clearSession();
              showLoginView();
            }
          })
          .withFailureHandler(function(error) {
            console.error('checkSession failed:', error);
            clearSession();
            showLoginView();
          })
          .checkSession(savedSessionId);
      } else {
        showLoginView();
      }
    };

    // ========================================
    // View Switching
    // ========================================
    function showLoginView() {
      document.getElementById('login-view').style.display = 'block';
      document.getElementById('app-view').style.display = 'none';
    }

    function showAppView() {
      document.getElementById('login-view').style.display = 'none';
      document.getElementById('app-view').style.display = 'block';

      // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ (v2.0: userType ì‚¬ìš©)
      if (currentUser) {
        var roleLabel = {
          'master': 'Admin',
          'agency': currentUser.agencyName || currentUser.agencyCode,
          'branch': 'Branch',
          'student': 'Student'
        };
        document.getElementById('user-info').textContent =
          currentUser.loginId + ' (' + (roleLabel[currentUser.userType] || currentUser.userType) + ')';
      }

      // 1. API ì—°ê²° í™•ì¸ í›„ 2. ë°ì´í„° ë¡œë“œ (GAS null ë°˜í™˜ ë¬¸ì œ ëŒ€ì‘)
      // ğŸ” ë””ë²„ê¹…: ì´ˆê°„ë‹¨ í…ŒìŠ¤íŠ¸ ë¨¼ì €
      console.log('[DEBUG] Testing testSimple...');
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('[DEBUG] testSimple result:', result);
          if (!result) {
            console.error('[DEBUG] testSimple returned null!');
            showMessage('ğŸš¨ ë””ë²„ê¹…: ê°€ì¥ ê°„ë‹¨í•œ í•¨ìˆ˜ë„ null ë°˜í™˜!');
            return;
          }
          console.log('[DEBUG] testSimple success! Now testing testApiConnection...');

          // 2. testApiConnection
          google.script.run
            .withSuccessHandler(function(conn) {
              console.log('[DEBUG] testApiConnection result:', conn);
              if (!conn || !conn.success) {
                console.error('testApiConnection failed:', conn);
                showMessage('ì„œë²„ ì—°ê²° ì‹¤íŒ¨. clasp push í›„ ì›¹ì•±ì„ ì¬ë°°í¬í•´ ì£¼ì„¸ìš”.');
                return;
              }

              console.log('[DEBUG] testApiConnection success! Now loading data...');
              loadStudentList();
              loadAgencyList();
            })
            .withFailureHandler(function(err) {
              console.error('testApiConnection error:', err);
              showMessage('ì„œë²„ ì—°ê²° ì˜¤ë¥˜. ì›¹ì•± ë°°í¬ ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
            })
            .testApiConnection();
        })
        .withFailureHandler(function(err) {
          console.error('[DEBUG] testSimple error:', err);
          showMessage('ğŸš¨ ë””ë²„ê¹…: testSimple ì‹¤íŒ¨!');
        })
        .testSimple();

      // agency ì—­í• ì´ë©´ ìœ í•™ì› ì„ íƒ í•„ë“œ ìˆ¨ê¸°ê¸° (v2.0: userType)
      if (currentUser.userType === 'agency') {
        document.getElementById('agency-select-group').style.display = 'none';
      }

      // master ì—­í• ì´ë©´ ìœ í•™ì› ê´€ë¦¬ íƒ­ í‘œì‹œ (v2.0: userType)
      if (currentUser.userType === 'master') {
        document.getElementById('agency-tab-btn').style.display = 'block';
      }
    }

    // ========================================
    // Session Helpers
    // ========================================
    function saveSession(sessionId, user) {
      currentSessionId = sessionId;
      currentUser = user;
      sessionStorage.setItem('sessionId', sessionId);
      sessionStorage.setItem('user', JSON.stringify(user));
    }

    function clearSession() {
      currentSessionId = null;
      currentUser = null;
      sessionStorage.removeItem('sessionId');
      sessionStorage.removeItem('user');
    }

    // ========================================
    // i18n
    // ========================================
    function switchLanguage(lang) {
      currentLang = lang;
      loadI18n(lang);
    }

    function loadI18n(lang) {
      google.script.run
        .withSuccessHandler(function(response) {
          // response null ë°©ì–´
          if (!response) {
            console.error('getLocaleStrings returned null/undefined');
            return;
          }

          if (response.success) {
            i18n = response.data;
            applyLanguage();
          } else {
            console.error('getLocaleStrings failed:', response.errorKey);
          }
        })
        .withFailureHandler(function(error) {
          console.error('i18n load error:', error);
        })
        .getLocaleStrings(lang);
    }

    function applyLanguage() {
      document.querySelectorAll('[data-i18n]').forEach(function(el) {
        var key = el.getAttribute('data-i18n');
        if (i18n[key]) {
          el.textContent = i18n[key];
        }
      });

      document.querySelectorAll('[data-placeholder-i18n]').forEach(function(el) {
        var key = el.getAttribute('data-placeholder-i18n');
        if (i18n[key]) {
          el.placeholder = i18n[key];
        }
      });
    }

    // ========================================
    // Login Handler
    // ========================================
    function handleLogin(event) {
      event.preventDefault();

      var loginId = document.getElementById('login-id').value;
      var password = document.getElementById('password').value;
      var userType = document.getElementById('user-type').value;
      var btn = document.getElementById('login-btn');

      // UI ì´ˆê¸°í™”
      document.getElementById('error').style.display = 'none';
      document.getElementById('success').style.display = 'none';
      document.getElementById('loading').style.display = 'block';
      btn.disabled = true;

      google.script.run
        .withSuccessHandler(function(response) {
          document.getElementById('loading').style.display = 'none';

          if (!response) {
            console.error('login returned null/undefined');
            btn.disabled = false;
            document.getElementById('error').textContent = 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜';
            document.getElementById('error').style.display = 'block';
            return;
          }
          if (response.success) {
            // v2.0: ì‘ë‹µ êµ¬ì¡° ë³€ê²½ (sessionId â†’ sessionToken, user ê°ì²´ ì—†ìŒ)
            console.log('[DEBUG] Login success! response.data:', response.data);
            console.log('[DEBUG] sessionToken:', response.data.sessionToken);

            var user = {
              userId: response.data.userId,
              userType: response.data.userType,
              agencyCode: response.data.agencyCode,
              loginId: loginId
            };

            saveSession(response.data.sessionToken, user);
            console.log('[DEBUG] Session saved. currentSessionId:', currentSessionId);

            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í›„ ì•± ë·°ë¡œ ì „í™˜
            document.getElementById('success').style.display = 'block';

            setTimeout(function() {
              showAppView();
            }, 500);
          } else {
            // ì—ëŸ¬ ì²˜ë¦¬
            btn.disabled = false;
            var errorKey = response.errorKey || 'err_unknown';
            var errorMessage = i18n[errorKey] || 'Login failed';
            document.getElementById('error').textContent = errorMessage;
            document.getElementById('error').style.display = 'block';
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('loading').style.display = 'none';
          btn.disabled = false;
          console.error('Login error:', error);
          document.getElementById('error').textContent = 'Network error';
          document.getElementById('error').style.display = 'block';
        })
        .login(loginId, password, userType);
    }

    // ========================================
    // Logout Handler
    // ========================================
    function handleLogout() {
      var sid = currentSessionId;
      clearSession();
      showLoginView();

      // ë¹„ë™ê¸°ë¡œ ì„œë²„ ì„¸ì…˜ë„ ì •ë¦¬
      if (sid) {
        google.script.run.logout(sid);
      }

      // í¼ ì´ˆê¸°í™”
      document.getElementById('login-id').value = '';
      document.getElementById('password').value = '';
      document.getElementById('login-btn').disabled = false;
      document.getElementById('error').style.display = 'none';
      document.getElementById('success').style.display = 'none';
    }

    // ==================== í•™ìƒ ëª©ë¡ ë¡œë“œ ====================
    function loadStudentList() {
      console.log('[DEBUG] loadStudentList called. currentSessionId:', currentSessionId);
      showLoadingIndicator(true);

      google.script.run
        .withSuccessHandler(function(response) {
          console.log('[DEBUG] getStudentList response:', response);
          showLoadingIndicator(false);

          // response null ë°©ì–´
          if (!response) {
            console.error('getStudentList returned null/undefined');
            console.error('[DEBUG] currentSessionId was:', currentSessionId);
            showMessage('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ - í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
          }

          if (response.success) {
            studentList = response.data;
            renderStudentTable();
          } else {
            showMessage(i18n[response.errorKey] || 'Error loading students');
          }
        })
        .withFailureHandler(function(error) {
          showLoadingIndicator(false);
          console.error('getStudentList failed:', error);
          showMessage(i18n['err_unknown']);
        })
        .getStudentList(currentSessionId, currentFilters);
    }

    // ==================== ìœ í•™ì› ëª©ë¡ ë¡œë“œ ====================
    function loadAgencyList() {
      google.script.run
        .withSuccessHandler(function(response) {
          // response null ë°©ì–´
          if (!response) {
            console.error('getAgencyList returned null/undefined');
            // ê¸°ë³¸ ì˜µì…˜ì€ ìœ ì§€
            var select = document.getElementById('agency-select');
            select.innerHTML = '<option value="" data-i18n="option_select">ì„ íƒ</option>';
            return;
          }

          if (response.success) {
            var select = document.getElementById('agency-select');
            select.innerHTML = '<option value="" data-i18n="option_select">ì„ íƒ</option>';

            if (response.data && response.data.length > 0) {
              response.data.forEach(function(agency) {
                var option = document.createElement('option');
                option.value = agency.AgencyCode;
                option.textContent = agency.AgencyName;
                select.appendChild(option);
              });
            }
          } else {
            console.error('getAgencyList failed:', response.errorKey);
          }
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load agency list:', error);
        })
        .getAgencyList(currentSessionId);
    }

    // ==================== í…Œì´ë¸” ë Œë”ë§ ====================
    function renderStudentTable() {
      var tbody = document.getElementById('student-list');
      tbody.innerHTML = '';

      if (studentList.length === 0) {
        document.getElementById('no-data').style.display = 'block';
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      document.getElementById('no-data').style.display = 'none';

      // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
      var start = (currentPage - 1) * itemsPerPage;
      var end = Math.min(start + itemsPerPage, studentList.length);
      var pageData = studentList.slice(start, end);

      // í…Œì´ë¸” í–‰ ìƒì„±
      pageData.forEach(function(student) {
        var tr = document.createElement('tr');

        tr.innerHTML =
          '<td>' + student.StudentID + '</td>' +
          '<td>' + student.NameKR + '</td>' +
          '<td>' + student.NameVN + '</td>' +
          '<td>' + formatDate(student.DOB) + '</td>' +
          '<td>' + (student.Gender === 'M' ? i18n['option_male'] : i18n['option_female']) + '</td>' +
          '<td>' + student.AgencyCode + '</td>' +
          '<td>' + (student.PhoneKR || '-') + '</td>' +
          '<td>' + formatDate(student.EnrollmentDate) + '</td>' +
          '<td class="actions">' +
            '<button class="btn-sm btn-edit" onclick="showEditForm(\'' + student.StudentID + '\')">' +
              i18n['btn_edit'] +
            '</button>' +
            (currentUser.userType === 'master' ?
              '<button class="btn-sm btn-delete" onclick="showDeleteDialog(\'' + student.StudentID + '\', \'' + student.NameKR + '\')">' +
                i18n['btn_delete'] +
              '</button>' : '') +
          '</td>';

        tbody.appendChild(tr);
      });

      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      renderPagination();
    }

    function renderPagination() {
      var totalPages = Math.ceil(studentList.length / itemsPerPage);
      var paginationDiv = document.getElementById('pagination');
      paginationDiv.innerHTML = '';

      if (totalPages <= 1) return;

      // ì´ì „ ë²„íŠ¼
      var prevBtn = document.createElement('button');
      prevBtn.textContent = 'â€¹';
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = function() {
        currentPage--;
        renderStudentTable();
      };
      paginationDiv.appendChild(prevBtn);

      // í˜ì´ì§€ ë²ˆí˜¸
      for (var i = 1; i <= totalPages; i++) {
        var pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = i === currentPage ? 'active' : '';
        pageBtn.onclick = (function(page) {
          return function() {
            currentPage = page;
            renderStudentTable();
          };
        })(i);
        paginationDiv.appendChild(pageBtn);
      }

      // ë‹¤ìŒ ë²„íŠ¼
      var nextBtn = document.createElement('button');
      nextBtn.textContent = 'â€º';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = function() {
        currentPage++;
        renderStudentTable();
      };
      paginationDiv.appendChild(nextBtn);
    }

    // ==================== ê²€ìƒ‰/ì •ë ¬ ====================
    function searchStudents() {
      var searchValue = document.getElementById('search-input').value;
      currentFilters.search = searchValue;
      currentPage = 1;
      loadStudentList();
    }

    function handleSearchKeyup(event) {
      if (event.key === 'Enter') {
        searchStudents();
      }
    }

    function sortStudents() {
      var sortValue = document.getElementById('sort-select').value;
      var parts = sortValue.split('-');
      currentFilters.sortBy = parts[0];
      currentFilters.sortOrder = parts[1];
      currentPage = 1;
      loadStudentList();
    }

    // ==================== í•™ìƒ ë“±ë¡ ====================
    function showCreateForm() {
      editingStudentId = null;
      document.getElementById('modal-title').setAttribute('data-i18n', 'title_add_student');
      document.getElementById('modal-title').textContent = i18n['title_add_student'];
      document.getElementById('student-form').reset();
      document.getElementById('student-form-modal').style.display = 'block';
    }

    function handleStudentSubmit(event) {
      event.preventDefault();

      var formData = {};
      var form = document.getElementById('student-form');
      var inputs = form.querySelectorAll('input, select');

      inputs.forEach(function(input) {
        if (input.name) {
          formData[input.name] = input.value;
        }
      });

      showLoadingIndicator(true);

      if (editingStudentId) {
        // ìˆ˜ì •
        google.script.run
          .withSuccessHandler(handleStudentSaveSuccess)
          .withFailureHandler(handleStudentSaveError)
          .updateStudent(currentSessionId, editingStudentId, formData);
      } else {
        // ë“±ë¡
        google.script.run
          .withSuccessHandler(handleStudentSaveSuccess)
          .withFailureHandler(handleStudentSaveError)
          .createStudent(currentSessionId, formData);
      }
    }

    function handleStudentSaveSuccess(response) {
      showLoadingIndicator(false);
      if (response.success) {
        showMessage(i18n['msg_save_success']);
        closeModal();
        loadStudentList();
      } else {
        showMessage(i18n[response.errorKey] || 'Save failed');
      }
    }

    function handleStudentSaveError(error) {
      showLoadingIndicator(false);
      showMessage(i18n['err_unknown']);
    }

    // ==================== í•™ìƒ ìˆ˜ì • ====================
    function showEditForm(studentId) {
      editingStudentId = studentId;
      document.getElementById('modal-title').setAttribute('data-i18n', 'title_edit_student');
      document.getElementById('modal-title').textContent = i18n['title_edit_student'];

      showLoadingIndicator(true);

      google.script.run
        .withSuccessHandler(function(response) {
          showLoadingIndicator(false);
          if (response.success) {
            fillFormWithData(response.data);
            document.getElementById('student-form-modal').style.display = 'block';
          } else {
            showMessage(i18n[response.errorKey]);
          }
        })
        .withFailureHandler(function(error) {
          showLoadingIndicator(false);
          showMessage(i18n['err_unknown']);
        })
        .getStudentById(currentSessionId, studentId);
    }

    function fillFormWithData(student) {
      var form = document.getElementById('student-form');
      for (var field in student) {
        var input = form.querySelector('[name="' + field + '"]');
        if (input) {
          input.value = student[field] || '';
        }
      }
    }

    // ==================== í•™ìƒ ì‚­ì œ ====================
    function showDeleteDialog(studentId, studentName) {
      deletingStudentId = studentId;
      document.getElementById('delete-student-name').textContent = studentName;
      document.getElementById('delete-confirm').style.display = 'block';
    }

    function confirmDelete() {
      showLoadingIndicator(true);

      google.script.run
        .withSuccessHandler(function(response) {
          showLoadingIndicator(false);
          if (response.success) {
            showMessage(i18n['msg_delete_success']);
            closeDeleteDialog();
            loadStudentList();
          } else {
            showMessage(i18n[response.errorKey]);
          }
        })
        .withFailureHandler(function(error) {
          showLoadingIndicator(false);
          showMessage(i18n['err_unknown']);
        })
        .deleteStudent(currentSessionId, deletingStudentId);
    }

    function closeDeleteDialog() {
      deletingStudentId = null;
      document.getElementById('delete-confirm').style.display = 'none';
    }

    // ==================== ìœ í‹¸ë¦¬í‹° ====================
    function closeModal() {
      document.getElementById('student-form-modal').style.display = 'none';
      editingStudentId = null;
    }

    function showLoadingIndicator(show) {
      document.getElementById('student-loading').style.display = show ? 'block' : 'none';
    }

    function showMessage(message) {
      // ë©”ì‹œì§€ í‘œì‹œ ë¡œì§ (ì¶”í›„ Toast UI êµ¬í˜„)
      alert(message);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      var date = new Date(dateStr);
      return date.toLocaleDateString('ko-KR');
    }

    // ==================== íƒ­ ì „í™˜ ====================
    function switchTab(tabName) {
      // ëª¨ë“  íƒ­ ë²„íŠ¼ì—ì„œ active ì œê±°
      var tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(function(btn) {
        btn.classList.remove('active');
      });

      // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
      var tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(function(content) {
        content.classList.remove('active');
      });

      // ì„ íƒëœ íƒ­ í™œì„±í™”
      if (tabName === 'student') {
        document.getElementById('student-tab').classList.add('active');
        document.querySelector('[onclick="switchTab(\'student\')"]').classList.add('active');
      } else if (tabName === 'agency') {
        document.getElementById('agency-tab').classList.add('active');
        document.getElementById('agency-tab-btn').classList.add('active');
        loadAgencyListForAdmin();
      }
    }

    // ==================== ìœ í•™ì› ê´€ë¦¬ ====================

    function loadAgencyListForAdmin() {
      console.log('[DEBUG] loadAgencyListForAdmin called. currentSessionId:', currentSessionId);
      showAgencyLoadingIndicator(true);

      google.script.run
        .withSuccessHandler(function(response) {
          console.log('[DEBUG] getAgencyListForAdmin response:', response);
          showAgencyLoadingIndicator(false);

          // response null ë°©ì–´
          if (!response) {
            console.error('getAgencyListForAdmin returned null/undefined');
            console.error('[DEBUG] currentSessionId was:', currentSessionId);
            showMessage('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ - ìœ í•™ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
          }

          if (response.success) {
            agencyList = response.data || [];
            currentAgencyPage = 1;
            renderAgencyTable();
            renderAgencyPagination();
          } else {
            showMessage(i18n[response.errorKey]);
          }
        })
        .withFailureHandler(function(error) {
          showAgencyLoadingIndicator(false);
          console.error('getAgencyListForAdmin failed:', error);
          showMessage(i18n['err_unknown']);
        })
        .getAgencyListForAdmin(currentSessionId);
    }

    function renderAgencyTable() {
      var tbody = document.getElementById('agency-table-body');
      var noData = document.getElementById('agency-no-data');

      if (agencyList.length === 0) {
        tbody.innerHTML = '';
        noData.style.display = 'block';
        return;
      }

      noData.style.display = 'none';

      // í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚°
      var start = (currentAgencyPage - 1) * agencyItemsPerPage;
      var end = start + agencyItemsPerPage;
      var pageData = agencyList.slice(start, end);

      var html = '';
      pageData.forEach(function(agency) {
        html += '<tr>';
        html += '<td>' + agency.AgencyCode + '</td>';
        html += '<td>' + (agency.AgencyName || '-') + '</td>';
        html += '<td>' + agency.LoginID + '</td>';
        html += '<td>' + (agency.Role === 'master' ? 'ê´€ë¦¬ì' : agency.Role === 'branch' ? 'í•œêµ­ ì§€ì ' : 'ìœ í•™ì›') + '</td>';
        html += '<td>' + formatDate(agency.CreatedAt) + '</td>';
        html += '<td class="action-buttons">';
        html += '<button class="btn-edit" onclick="showEditAgencyForm(\'' + agency.AgencyCode + '\')" data-i18n="btn_edit">ìˆ˜ì •</button>';
        if (agency.AgencyCode !== 'MASTER') {
          html += '<button class="btn-delete" onclick="showAgencyDeleteDialog(\'' + agency.AgencyCode + '\', \'' + (agency.AgencyName || agency.AgencyCode) + '\')" data-i18n="btn_delete">ì‚­ì œ</button>';
        }
        html += '</td>';
        html += '</tr>';
      });

      tbody.innerHTML = html;
    }

    function renderAgencyPagination() {
      var totalPages = Math.ceil(agencyList.length / agencyItemsPerPage);
      var container = document.getElementById('agency-pagination');

      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      var html = '<button onclick="currentAgencyPage=1; renderAgencyTable(); renderAgencyPagination();">&laquo;</button>';

      for (var i = 1; i <= totalPages; i++) {
        if (i === currentAgencyPage) {
          html += '<button class="active">' + i + '</button>';
        } else {
          html += '<button onclick="currentAgencyPage=' + i + '; renderAgencyTable(); renderAgencyPagination();">' + i + '</button>';
        }
      }

      html += '<button onclick="currentAgencyPage=' + totalPages + '; renderAgencyTable(); renderAgencyPagination();">&raquo;</button>';
      container.innerHTML = html;
    }

    function searchAgencies() {
      var searchText = document.getElementById('agency-search').value.toLowerCase();

      if (!searchText) {
        loadAgencyListForAdmin();
        return;
      }

      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            agencyList = (response.data || []).filter(function(agency) {
              return (agency.AgencyCode && agency.AgencyCode.toLowerCase().indexOf(searchText) >= 0) ||
                     (agency.AgencyName && agency.AgencyName.toLowerCase().indexOf(searchText) >= 0) ||
                     (agency.LoginID && agency.LoginID.toLowerCase().indexOf(searchText) >= 0);
            });
            currentAgencyPage = 1;
            renderAgencyTable();
            renderAgencyPagination();
          }
        })
        .getAgencyListForAdmin(currentSessionId);
    }

    function showCreateAgencyForm() {
      editingAgencyCode = null;
      document.getElementById('agency-modal-title').setAttribute('data-i18n', 'title_add_agency');
      document.getElementById('agency-modal-title').textContent = i18n['title_add_agency'] || 'ìœ í•™ì› ë“±ë¡';

      document.getElementById('agency-form').reset();
      document.getElementById('agency-code-input').disabled = false;
      document.getElementById('agency-password-input').required = true;

      document.getElementById('agency-form-modal').style.display = 'flex';
    }

    function showEditAgencyForm(agencyCode) {
      editingAgencyCode = agencyCode;
      document.getElementById('agency-modal-title').setAttribute('data-i18n', 'title_edit_agency');
      document.getElementById('agency-modal-title').textContent = i18n['title_edit_agency'] || 'ìœ í•™ì› ì •ë³´ ìˆ˜ì •';

      showAgencyLoadingIndicator(true);

      google.script.run
        .withSuccessHandler(function(response) {
          showAgencyLoadingIndicator(false);

          if (response.success) {
            fillAgencyFormWithData(response.data);
            document.getElementById('agency-code-input').disabled = true;
            document.getElementById('agency-password-input').required = false;
            document.getElementById('agency-form-modal').style.display = 'flex';
          } else {
            showMessage(i18n[response.errorKey]);
          }
        })
        .withFailureHandler(function(error) {
          showAgencyLoadingIndicator(false);
          showMessage(i18n['err_unknown']);
        })
        .getAgencyById(currentSessionId, agencyCode);
    }

    function fillAgencyFormWithData(agency) {
      var form = document.getElementById('agency-form');
      form.AgencyCode.value = agency.AgencyCode || '';
      form.AgencyName.value = agency.AgencyName || '';
      form.LoginID.value = agency.LoginID || '';
      form.Password.value = '';
      form.Role.value = agency.Role || 'agency';
    }

    function handleAgencySubmit(event) {
      event.preventDefault();

      var formData = new FormData(event.target);
      var agencyData = {};

      formData.forEach(function(value, key) {
        if (value) agencyData[key] = value;
      });

      showAgencyLoadingIndicator(true);

      if (editingAgencyCode) {
        // ìˆ˜ì •
        google.script.run
          .withSuccessHandler(function(response) {
            showAgencyLoadingIndicator(false);

            if (response.success) {
              showMessage(i18n['msg_save_success']);
              closeAgencyModal();
              loadAgencyListForAdmin();
            } else {
              showMessage(i18n[response.errorKey]);
            }
          })
          .withFailureHandler(function(error) {
            showAgencyLoadingIndicator(false);
            showMessage(i18n['err_unknown']);
          })
          .updateAgency(currentSessionId, editingAgencyCode, agencyData);
      } else {
        // ë“±ë¡
        google.script.run
          .withSuccessHandler(function(response) {
            showAgencyLoadingIndicator(false);

            if (response.success) {
              showMessage(i18n['msg_save_success']);
              closeAgencyModal();
              loadAgencyListForAdmin();
            } else {
              showMessage(i18n[response.errorKey]);
            }
          })
          .withFailureHandler(function(error) {
            showAgencyLoadingIndicator(false);
            showMessage(i18n['err_unknown']);
          })
          .createAgency(currentSessionId, agencyData);
      }
    }

    function showAgencyDeleteDialog(agencyCode, agencyName) {
      deletingAgencyCode = agencyCode;
      document.getElementById('delete-agency-name').textContent = agencyName;
      document.getElementById('agency-delete-confirm').style.display = 'flex';
    }

    function confirmAgencyDelete() {
      if (!deletingAgencyCode) return;

      showAgencyLoadingIndicator(true);

      google.script.run
        .withSuccessHandler(function(response) {
          showAgencyLoadingIndicator(false);

          if (response.success) {
            showMessage(i18n['msg_delete_success']);
            closeAgencyDeleteDialog();
            loadAgencyListForAdmin();
          } else {
            showMessage(i18n[response.errorKey]);
          }
        })
        .withFailureHandler(function(error) {
          showAgencyLoadingIndicator(false);
          showMessage(i18n['err_unknown']);
        })
        .deleteAgency(currentSessionId, deletingAgencyCode);
    }

    function closeAgencyModal() {
      document.getElementById('agency-form-modal').style.display = 'none';
      editingAgencyCode = null;
    }

    function closeAgencyDeleteDialog() {
      deletingAgencyCode = null;
      document.getElementById('agency-delete-confirm').style.display = 'none';
    }

    function showAgencyLoadingIndicator(show) {
      document.getElementById('agency-loading').style.display = show ? 'block' : 'none';
    }
  </script>
</body>
</html>
