<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AJU E&J - í•™ìƒ ì¼ê´„ ë“±ë¡/ë‚´ë³´ë‚´ê¸°</title>
  <style>
    /* ===== RESET & BASE ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    /* ===== CONTAINER ===== */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    /* ===== HEADER ===== */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 28px;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .lang-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .lang-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .btn-close {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .btn-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    /* ===== MAIN CONTENT ===== */
    .content {
      padding: 40px;
    }

    .section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      border: 2px solid #e9ecef;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-description {
      color: #6c757d;
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    /* ===== UPLOAD ZONE ===== */
    .upload-zone {
      border: 3px dashed #667eea;
      border-radius: 12px;
      padding: 60px 40px;
      text-align: center;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .upload-zone:hover {
      background: #f8f9ff;
      border-color: #764ba2;
      transform: translateY(-2px);
    }

    .upload-zone.drag-over {
      background: #e8ebff;
      border-color: #764ba2;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 64px;
      color: #667eea;
      margin-bottom: 20px;
    }

    .upload-text {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .upload-hint {
      color: #6c757d;
      font-size: 14px;
    }

    .file-input {
      display: none;
    }

    .file-selected {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e9;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .file-icon {
      font-size: 32px;
    }

    .file-details {
      flex: 1;
    }

    .file-name {
      font-weight: 600;
      color: #2e7d32;
      margin-bottom: 4px;
      word-break: break-all;
    }

    .file-size {
      font-size: 13px;
      color: #66bb6a;
    }

    .btn-remove-file {
      background: #ef5350;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-remove-file:hover {
      background: #c62828;
      transform: translateY(-1px);
    }

    /* ===== BUTTONS ===== */
    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
    }

    .btn-success {
      background: #28a745;
      color: white;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .btn-success:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    /* ===== RESULTS ===== */
    .results-container {
      display: none;
      margin-top: 30px;
    }

    .results-container.show {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    .stat-card.success {
      border-color: #28a745;
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    }

    .stat-card.error {
      border-color: #dc3545;
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
    }

    .stat-card.total {
      border-color: #667eea;
      background: linear-gradient(135deg, #e8ebff 0%, #d1d5ff 100%);
    }

    .stat-number {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-card.success .stat-number {
      color: #28a745;
    }

    .stat-card.error .stat-number {
      color: #dc3545;
    }

    .stat-card.total .stat-number {
      color: #667eea;
    }

    .stat-label {
      font-size: 14px;
      font-weight: 600;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .error-list {
      background: white;
      border-radius: 10px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid #ffcdd2;
    }

    .error-item {
      padding: 12px;
      margin-bottom: 12px;
      background: #fff5f5;
      border-left: 4px solid #dc3545;
      border-radius: 6px;
    }

    .error-item:last-child {
      margin-bottom: 0;
    }

    .error-row {
      font-weight: 700;
      color: #dc3545;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .error-message {
      color: #6c757d;
      font-size: 13px;
      line-height: 1.5;
    }

    .success-list {
      background: white;
      border-radius: 10px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid #c8e6c9;
    }

    .success-item {
      padding: 12px;
      margin-bottom: 12px;
      background: #f1f8f4;
      border-left: 4px solid #28a745;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }

    .success-item:last-child {
      margin-bottom: 0;
    }

    .success-info {
      flex: 1;
    }

    .success-id {
      font-weight: 700;
      color: #28a745;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .success-name {
      color: #6c757d;
      font-size: 13px;
    }

    .success-icon {
      font-size: 24px;
      color: #28a745;
    }

    /* ===== SAMPLE TEMPLATE ===== */
    .sample-template {
      background: white;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #e9ecef;
    }

    .sample-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .sample-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sample-preview {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.8;
      color: #495057;
      border: 1px solid #dee2e6;
    }

    .sample-note {
      margin-top: 15px;
      padding: 12px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 6px;
      font-size: 13px;
      color: #856404;
      line-height: 1.6;
    }

    /* ===== LOADING ===== */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .loading.show {
      display: flex;
    }

    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      max-width: 400px;
    }

    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #667eea;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .loading-hint {
      font-size: 14px;
      color: #6c757d;
    }

    /* ===== EXPORT SECTION ===== */
    .export-info {
      background: white;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #e9ecef;
      margin-bottom: 20px;
    }

    .export-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .export-stat {
      text-align: center;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .export-stat-number {
      font-size: 32px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .export-stat-label {
      font-size: 13px;
      color: #6c757d;
      font-weight: 600;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .content {
        padding: 20px;
      }

      .section {
        padding: 20px;
      }

      .header {
        padding: 20px;
      }

      .header-title {
        font-size: 22px;
      }

      .upload-zone {
        padding: 40px 20px;
      }

      .upload-icon {
        font-size: 48px;
      }

      .upload-text {
        font-size: 16px;
      }

      .button-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .file-selected {
        flex-direction: column;
        align-items: flex-start;
      }

      .btn-remove-file {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .header-title {
        font-size: 18px;
      }

      .section-title {
        font-size: 18px;
      }

      .stat-number {
        font-size: 36px;
      }

      .export-stat-number {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loading" class="loading">
    <div class="loading-content">
      <div class="spinner"></div>
      <div class="loading-text" data-i18n="bulk_loading_title">ì²˜ë¦¬ ì¤‘...</div>
      <div class="loading-hint" data-i18n="bulk_loading_hint">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-title">
        <span>ğŸ“Š</span>
        <span data-i18n="bulk_page_title">í•™ìƒ ì¼ê´„ ë“±ë¡/ë‚´ë³´ë‚´ê¸°</span>
      </div>
      <div class="header-actions">
        <button class="lang-toggle" id="langToggle" onclick="toggleLanguage()">
          <span id="langText">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</span>
        </button>
        <a href="/" class="btn-close" data-i18n="btn_close">ë‹«ê¸°</a>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- Import Section -->
      <div class="section">
        <div class="section-title">
          <span>ğŸ“¥</span>
          <span data-i18n="bulk_import_title">CSV íŒŒì¼ë¡œ í•™ìƒ ì¼ê´„ ë“±ë¡</span>
        </div>
        <div class="section-description" data-i18n="bulk_import_desc">
          CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ì—¬ëŸ¬ í•™ìƒì˜ ì •ë³´ë¥¼ í•œ ë²ˆì— ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì€ UTF-8 ì¸ì½”ë”©ì˜ CSV íŒŒì¼ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
        </div>

        <!-- Sample Template -->
        <div class="sample-template">
          <div class="sample-header">
            <div class="sample-title">
              <span>ğŸ“„</span>
              <span data-i18n="bulk_sample_title">CSV í…œí”Œë¦¿ ì˜ˆì‹œ</span>
            </div>
            <button class="btn btn-secondary" onclick="downloadSampleCSV()">
              <span>â¬‡ï¸</span>
              <span data-i18n="bulk_download_sample">ìƒ˜í”Œ ë‹¤ìš´ë¡œë“œ</span>
            </button>
          </div>
          <div class="sample-preview" id="samplePreview">
StudentID,NameKR,NameVN,Gender,DOB,Phone,Email,AgencyCode,HighSchoolGPA,ParentPhone,ParentName,Address,EnrollDate
25-HANOI-001,ê¹€í•˜ë…¸ì´,Nguyen Van A,M,2005-03-15,010-1234-5678,student1@example.com,HANOI,3.8,010-9999-8888,Nguyen Thi B,í•˜ë…¸ì´ì‹œ ë™ë‹¤êµ¬,2025-01-15
25-DANANG-001,ë°•ë‹¤ë‚­,Tran Van C,F,2005-07-22,010-2345-6789,student2@example.com,DANANG,4.0,010-8888-7777,Tran Thi D,ë‹¤ë‚­ì‹œ í•´ì•ˆêµ¬,2025-01-20
          </div>
          <div class="sample-note">
            <strong data-i18n="bulk_note_title">âš ï¸ ì£¼ì˜ì‚¬í•­:</strong><br>
            <span data-i18n="bulk_note_1">â€¢ ì²« ë²ˆì§¸ í–‰ì€ ë°˜ë“œì‹œ ì»¬ëŸ¼ëª…(í—¤ë”)ì´ì–´ì•¼ í•©ë‹ˆë‹¤.</span><br>
            <span data-i18n="bulk_note_2">â€¢ StudentID í˜•ì‹: YY-AGENCY-SEQ (ì˜ˆ: 25-HANOI-001)</span><br>
            <span data-i18n="bulk_note_3">â€¢ GenderëŠ” M(ë‚¨ì„±) ë˜ëŠ” F(ì—¬ì„±)ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span><br>
            <span data-i18n="bulk_note_4">â€¢ DOB(ìƒë…„ì›”ì¼) í˜•ì‹: YYYY-MM-DD</span><br>
            <span data-i18n="bulk_note_5">â€¢ EnrollDate(ë“±ë¡ì¼) í˜•ì‹: YYYY-MM-DD</span>
          </div>
        </div>

        <!-- Upload Zone -->
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('csvFileInput').click()">
          <div class="upload-icon">ğŸ“‚</div>
          <div class="upload-text" data-i18n="bulk_upload_text">CSV íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</div>
          <div class="upload-hint" data-i18n="bulk_upload_hint">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸ & ë“œë¡­</div>
        </div>
        <input type="file" id="csvFileInput" class="file-input" accept=".csv" onchange="handleFileSelect(event)">

        <!-- File Selected -->
        <div id="fileSelected" class="file-selected" style="display: none;">
          <div class="file-info">
            <div class="file-icon">ğŸ“„</div>
            <div class="file-details">
              <div class="file-name" id="fileName">example.csv</div>
              <div class="file-size" id="fileSize">10 KB</div>
            </div>
          </div>
          <button class="btn-remove-file" onclick="removeFile()">
            <span data-i18n="btn_remove">ì œê±°</span>
          </button>
        </div>

        <!-- Import Button -->
        <div class="button-group">
          <button class="btn btn-primary" id="importBtn" onclick="importCSV()" disabled>
            <span>ğŸ“¥</span>
            <span data-i18n="bulk_import_btn">CSV íŒŒì¼ ê°€ì ¸ì˜¤ê¸°</span>
          </button>
        </div>

        <!-- Import Results -->
        <div id="importResults" class="results-container">
          <div class="stats-grid">
            <div class="stat-card total">
              <div class="stat-number" id="totalCount">0</div>
              <div class="stat-label" data-i18n="bulk_stat_total">ì´ ì²˜ë¦¬</div>
            </div>
            <div class="stat-card success">
              <div class="stat-number" id="successCount">0</div>
              <div class="stat-label" data-i18n="bulk_stat_success">ì„±ê³µ</div>
            </div>
            <div class="stat-card error">
              <div class="stat-number" id="errorCount">0</div>
              <div class="stat-label" data-i18n="bulk_stat_error">ì‹¤íŒ¨</div>
            </div>
          </div>

          <!-- Success List -->
          <div id="successListContainer" style="display: none; margin-bottom: 20px;">
            <div class="section-title">
              <span>âœ…</span>
              <span data-i18n="bulk_success_list_title">ì„±ê³µ ëª©ë¡</span>
            </div>
            <div class="success-list" id="successList"></div>
          </div>

          <!-- Error List -->
          <div id="errorListContainer" style="display: none;">
            <div class="section-title">
              <span>âŒ</span>
              <span data-i18n="bulk_error_list_title">ì˜¤ë¥˜ ëª©ë¡</span>
            </div>
            <div class="error-list" id="errorList"></div>
          </div>
        </div>
      </div>

      <!-- Export Section -->
      <div class="section">
        <div class="section-title">
          <span>ğŸ“¤</span>
          <span data-i18n="bulk_export_title">í•™ìƒ ë°ì´í„° CSVë¡œ ë‚´ë³´ë‚´ê¸°</span>
        </div>
        <div class="section-description" data-i18n="bulk_export_desc">
          í˜„ì¬ ë“±ë¡ëœ í•™ìƒ ë°ì´í„°ë¥¼ CSV íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—­í• ì— ë”°ë¼ ì ‘ê·¼ ê°€ëŠ¥í•œ í•™ìƒ ë°ì´í„°ë§Œ ë‚´ë³´ë‚´ì§‘ë‹ˆë‹¤.
        </div>

        <!-- Export Info -->
        <div class="export-info">
          <div class="export-stats">
            <div class="export-stat">
              <div class="export-stat-number" id="exportTotalStudents">-</div>
              <div class="export-stat-label" data-i18n="bulk_export_total">ë‚´ë³´ë‚¼ í•™ìƒ ìˆ˜</div>
            </div>
            <div class="export-stat">
              <div class="export-stat-number" id="exportUserRole">-</div>
              <div class="export-stat-label" data-i18n="bulk_export_role">ë‚´ ê¶Œí•œ</div>
            </div>
          </div>

          <div class="button-group">
            <button class="btn btn-success" onclick="exportCSV()">
              <span>ğŸ“¤</span>
              <span data-i18n="bulk_export_btn">CSV íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸°</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== GLOBAL VARIABLES =====
    let sessionId = null;
    let currentLang = 'ko';
    let selectedFile = null;
    let i18nStrings = {};

    // ===== SESSION INITIALIZATION =====
    function initSession() {
      // URL íŒŒë¼ë¯¸í„°ì—ì„œ sessionId ì¶”ì¶œ
      const urlParams = new URLSearchParams(window.location.search);
      const urlSessionId = urlParams.get('sessionId');

      if (urlSessionId) {
        sessionId = urlSessionId;
        loadUserInfo();
      } else {
        // sessionIdê°€ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
        window.location.href = '/';
      }
    }

    // ===== LOAD USER INFO =====
    function loadUserInfo() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            document.getElementById('exportUserRole').textContent = result.data.role.toUpperCase();
            loadExportStats();
          } else {
            alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            window.location.href = '/';
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ' + error.message);
          window.location.href = '/';
        })
        .getUserInfo(sessionId);
    }

    // ===== LOAD EXPORT STATS =====
    function loadExportStats() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            document.getElementById('exportTotalStudents').textContent = result.data.count || 0;
          }
        })
        .withFailureHandler(function(error) {
          console.error('Export stats load error:', error);
        })
        .getStudentCount(sessionId);
    }

    // ===== i18n =====
    function loadI18n() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            i18nStrings = result.data;
            applyI18n();
          }
        })
        .withFailureHandler(function(error) {
          console.error('i18n load error:', error);
        })
        .getLocaleStrings(currentLang);
    }

    function applyI18n() {
      const elements = document.querySelectorAll('[data-i18n]');
      elements.forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (i18nStrings[key]) {
          if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
            el.placeholder = i18nStrings[key];
          } else {
            el.textContent = i18nStrings[key];
          }
        }
      });

      // Update language toggle button
      const langText = currentLang === 'ko' ? 'ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t' : 'ğŸ‡°ğŸ‡· í•œêµ­ì–´';
      document.getElementById('langText').textContent = langText;
    }

    function toggleLanguage() {
      currentLang = currentLang === 'ko' ? 'vi' : 'ko';
      loadI18n();
    }

    // ===== DRAG & DROP =====
    function setupDragDrop() {
      const uploadZone = document.getElementById('uploadZone');

      uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.add('drag-over');
      });

      uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.remove('drag-over');
      });

      uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          if (file.name.endsWith('.csv')) {
            handleFile(file);
          } else {
            alert('CSV íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
          }
        }
      });
    }

    // ===== FILE HANDLING =====
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    function handleFile(file) {
      selectedFile = file;

      // Display file info
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
      document.getElementById('fileSelected').style.display = 'flex';
      document.getElementById('importBtn').disabled = false;

      // Hide previous results
      document.getElementById('importResults').classList.remove('show');
    }

    function removeFile() {
      selectedFile = null;
      document.getElementById('csvFileInput').value = '';
      document.getElementById('fileSelected').style.display = 'none';
      document.getElementById('importBtn').disabled = true;
      document.getElementById('importResults').classList.remove('show');
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    // ===== CSV IMPORT =====
    function importCSV() {
      if (!selectedFile) {
        alert('CSV íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const csvContent = e.target.result;

        showLoading();
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            if (result.success) {
              displayImportResults(result.data);
            } else {
              alert('CSV ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            alert('CSV ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜: ' + error.message);
          })
          .importStudentsFromCSV(sessionId, csvContent);
      };

      reader.readAsText(selectedFile, 'UTF-8');
    }

    function displayImportResults(data) {
      const resultsContainer = document.getElementById('importResults');
      resultsContainer.classList.add('show');

      // Update stats
      document.getElementById('totalCount').textContent = data.total || 0;
      document.getElementById('successCount').textContent = data.successCount || 0;
      document.getElementById('errorCount').textContent = data.errorCount || 0;

      // Display success list
      if (data.successCount > 0) {
        const successListContainer = document.getElementById('successListContainer');
        const successList = document.getElementById('successList');
        successListContainer.style.display = 'block';
        successList.innerHTML = '';

        data.successList.forEach(item => {
          const div = document.createElement('div');
          div.className = 'success-item';
          div.innerHTML = `
            <div class="success-info">
              <div class="success-id">${escapeHtml(item.studentId)}</div>
              <div class="success-name">${escapeHtml(item.nameKR || '')} / ${escapeHtml(item.nameVN || '')}</div>
            </div>
            <div class="success-icon">âœ“</div>
          `;
          successList.appendChild(div);
        });
      } else {
        document.getElementById('successListContainer').style.display = 'none';
      }

      // Display error list
      if (data.errorCount > 0) {
        const errorListContainer = document.getElementById('errorListContainer');
        const errorList = document.getElementById('errorList');
        errorListContainer.style.display = 'block';
        errorList.innerHTML = '';

        data.errorList.forEach(item => {
          const div = document.createElement('div');
          div.className = 'error-item';
          div.innerHTML = `
            <div class="error-row">í–‰ ${item.row}</div>
            <div class="error-message">${escapeHtml(item.error)}</div>
          `;
          errorList.appendChild(div);
        });
      } else {
        document.getElementById('errorListContainer').style.display = 'none';
      }

      // Update export stats
      loadExportStats();
    }

    // ===== CSV EXPORT =====
    function exportCSV() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            downloadCSV(result.data);
          } else {
            alert('CSV ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          alert('CSV ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜: ' + error.message);
        })
        .exportStudentsToCSV(sessionId);
    }

    function downloadCSV(csvContent) {
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'students_' + new Date().toISOString().split('T')[0] + '.csv');
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // ===== SAMPLE CSV DOWNLOAD =====
    function downloadSampleCSV() {
      const sampleCSV = `StudentID,NameKR,NameVN,Gender,DOB,Phone,Email,AgencyCode,HighSchoolGPA,ParentPhone,ParentName,Address,EnrollDate
25-HANOI-001,ê¹€í•˜ë…¸ì´,Nguyen Van A,M,2005-03-15,010-1234-5678,student1@example.com,HANOI,3.8,010-9999-8888,Nguyen Thi B,í•˜ë…¸ì´ì‹œ ë™ë‹¤êµ¬,2025-01-15
25-DANANG-001,ë°•ë‹¤ë‚­,Tran Van C,F,2005-07-22,010-2345-6789,student2@example.com,DANANG,4.0,010-8888-7777,Tran Thi D,ë‹¤ë‚­ì‹œ í•´ì•ˆêµ¬,2025-01-20
25-HOCHIMINH-001,ì´í˜¸ì¹˜ë¯¼,Le Thi E,M,2005-11-30,010-3456-7890,student3@example.com,HOCHIMINH,3.5,010-7777-6666,Le Van F,í˜¸ì¹˜ë¯¼ì‹œ 1êµ¬,2025-02-01`;

      const BOM = '\uFEFF';
      const blob = new Blob([BOM + sampleCSV], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'student_template_sample.csv');
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // ===== LOADING =====
    function showLoading() {
      document.getElementById('loading').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
    }

    // ===== UTILITY =====
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text || '').replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // ===== INITIALIZATION =====
    window.onload = function() {
      initSession();
      loadI18n();
      setupDragDrop();
    };
  </script>
</body>
</html>
